<!-- new-project.component.html -->
<div class="toolbar">
  <p-tabs value="0">
    <p-tablist>
      <p-tab value="0"> {{ "Paramètres" | translate }} </p-tab>
      <p-tab value="1"> {{ "Blocks" | translate }} </p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <div class="container-parametres">
          <div class="container-label">
            <label for="moduleName">{{ "Titre" | translate }}</label>
            <input
              class="input"
              id="moduleName"
              type="text"
              pInputText
              [(ngModel)]="currentModule().title"
              autocomplete="false"
            />
          </div>
          <div class="container-label">
            <label for="moduleDescription">{{
              "Description" | translate
            }}</label>
            <textarea
              class="input"
              id="moduleDescription"
              type="text"
              pTextarea
              [(ngModel)]="currentModule().description"
              autocomplete="false"
            ></textarea>
          </div>
          <div class="container-label">
            <label for="gameSystem">{{ "Jeux" | translate }}</label>
            <p-select
              [options]="gameSystems()"
              [(ngModel)]="currentGameSystem"
              (onChange)="onGameSystemChange($event)"
              optionLabel="name"
              placeholder="Selectionner un jeux"
              inputId="gameSystem"
            ></p-select>
          </div>
          <div class="container-label">
            <app-user-avatar-choose  ></app-user-avatar-choose>
          </div>
          <p-button label="Save" icon="pi pi-save" (onClick)="save()" severity="success" />
          <p-button
            label="Générer avec l'IA"
            icon="pi pi-sparkles"
            styleClass="p-button-help p-button-raised"
            (onClick)="generateCompleteModule()"
            [disabled]="!currentUser()"
          >
          </p-button>
        </div>
      </p-tabpanel>
      <p-tabpanel value="1">
        <div class="icone-grab">
          @for(block of availableBlocks; track block.type) {
          <div
            class="icon-item"
            (mousedown)="startIconDrag($event, block.type)"
            tabindex="0"
            role="button"
            (keydown.enter)="startIconDrag($event, block.type)"
          >
            <i
              [class]="geticonByType(block.type)"
              [attr.data-type]="block.type"
              aria-hidden="true"
            ></i>
            <span> {{ getBlockPreview(block.type) }} </span>
          </div>
          }
        </div>

        <!-- Élément de preview qui suit le curseur -->
        @if(isDraggingIcon()){
        <div
          class="icon-drag-preview"
          [style.left.px]="dragPosition.x"
          [style.top.px]="dragPosition.y"
        >
          <i
            [class]="
              'pi ' + geticonByType(draggedIconType || enumBlockType.paragraph)
            "
            aria-hidden="true"
          ></i>
          <span>{{
            getBlockPreview(draggedIconType || enumBlockType.paragraph)
          }}</span>
        </div>
        }
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>
<div class="container-edit">
  <div class="editor">
    <!-- Main blocks container -->
    <div
      class="blocks-container"
      cdkDropList
      id="blocksList"
      [cdkDropListData]="blocks()"
      (cdkDropListDropped)="onDrop($event)"
      cdkDropListOrientation="vertical"
      [class.highlight-drop-zone]="isDraggingIcon()"
    >
      <!-- Les blocs existants -->
      @for(block of blocks(); track block; let i = $index) {
      <div class="block-container" cdkDrag [cdkDragData]="block">
        <!-- Block header with controls -->
        <div class="block-header">
          <div class="block-controls-left">
            <i class="pi pi-bars" cdkDragHandle aria-hidden="true"></i>
          </div>
          <div class="texte">
            <i [class]="geticonByType(block.type)" aria-hidden="true"></i>
            <span>{{ getBlockPreview(block.type) }}</span>
          </div>
          <div class="block-controls">
            @if(block.id){
            <p-button
              icon="pi pi-sparkles"
              pTooltip="Générer avec l'IA"
              tooltipPosition="top"
              (click)="show(block.type, block.id)"
              [disabled]="block.type === enumBlockType.module"
              [rounded]="true"
              [text]="true"
              severity="help"
            />
            <p-button
              icon="pi pi-times"
              (click)="removeBlock(block.id)"
              pTooltip="Supprimer"
              tooltipPosition="top"
              [rounded]="true"
              [text]="true"
              severity="danger"
            />
            }
          </div>
        </div>

        <!-- Block content based on type -->
        @switch (block.type) { @case (enumBlockType.paragraph) { @let paragBlock
        = blockIsParagraphe(block); @if(paragBlock){
        <div class="text-block">
          <textarea
            pTextarea
            placeholder="Mon Histoire commence maintenant..."
            [(ngModel)]="paragBlock.paragraph"
          ></textarea>
        </div>
        } } @case (enumBlockType.stat) { @let statBlock = blockIsStat(block);
        <div class="stat-block">
          @if(statBlock) {
          <pre class="stat-values">{{ statBlock.statValues }}</pre>
          } @else {
          <div class="stat-placeholder">
            <i class="pi pi-folder" aria-hidden="true"></i>
            <span>Statistique</span>
          </div>
          }
        </div>
        } @case (enumBlockType.music) { @let musicBlock = blockIsMusic(block);
        <div class="music-block">
          @if(musicBlock && musicBlock.label) {
          <div class="music-content">
            <div class="music-details">
              <h4>{{ musicBlock.label }}</h4>
              @if(musicBlock.src) {
              <audio controls [src]="musicBlock.src"></audio>
              } @else {
              <p class="music-description">
                Aucune source audio disponible. Description de l'ambiance
                musicale souhaitée.
              </p>
              }
            </div>
          </div>
          } @else {
          <div class="music-placeholder">
            <i class="pi pi-volume-up" aria-hidden="true"></i>
            <span>Ambiance musicale</span>
          </div>
          }
        </div>
        } @case (enumBlockType.module) {
        <div class="module-block"></div>
        }
        <!-- @case ('Image') {
        <div class="title-block">
          <p-fileupload
            name="demo[]"
            url="https://www.primefaces.org/cdn/api/upload.php"
            (onUpload)="onUpload($event)"
            [multiple]="true"
            accept="image/*"
            maxFileSize="1000000"
            mode="advanced"
          >
            <ng-template #empty>
              <div>Glisse et dépose tes fichiers ici pour l'uploader.</div>
            </ng-template>
            <ng-template #content>
              @if(uploadedFiles.length){
              <ul>
                @for(file of uploadedFiles; track file){
                <li>{{ file.name }} - {{ file.size }} bytes</li>
                }
              </ul>
              }
            </ng-template>
          </p-fileupload>
        </div>
        }  -->
        }

        <!-- Custom preview when dragging -->
        <div *cdkDragPreview class="block-preview">
          <div class="block-preview-content">
            {{ getBlockPreview(block.type) }}
          </div>
        </div>

        <!-- Blue placeholder when dragging -->
        <div *cdkDragPlaceholder class="block-placeholder"></div>
      </div>
      }

      <!-- Placeholder pour l'ajout d'un nouveau block (identique au placeholder de réordonnancement) -->
      @if(isDraggingIcon() && isOverDropZone()){
      <div class="block-placeholder">
        <div class="placeholder-content">
          {{ getBlockPreview(draggedIconType || enumBlockType.paragraph) }}
        </div>
      </div>
      }
    </div>
  </div>
</div>
